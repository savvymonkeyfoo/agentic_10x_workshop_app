// schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// 1. Workshop Container
model Workshop {
  id          String   @id @default(uuid())
  clientName  String
  clientLogoUrl String?
  workshopDate  DateTime @default(now())
  createdAt   DateTime @default(now())
  status      String   @default("INPUT") // Draft, Input, Analysis
  strategyNarrative    String? @db.Text // Executive Summary
  strategyDependencies String? @db.Text // The Architect's Analysis
  strategyRisks        String? @db.Text // The Risk Officer's Analysis
  opportunities        Opportunity[]
  
  // Divergent Extension Relations
  context              WorkshopContext?
  ideaCards            IdeaCard[]
  assets               Asset[]
}

// 2. The Opportunity Asset
model Opportunity {
  id              String   @id @default(uuid())
  workshopId      String
  workshop        Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  canvasLastGeneratedAt DateTime? // Tracks when the Strategy One-Pager was last generated

  // Tab A: Strategic Context
  projectName       String
  description       String?  @db.Text // [NEW] Description from Ideation
  frictionStatement String
  strategicHorizon  String   // "GROWTH", "OPS", "STRATEGY"
  whyDoIt           String   
  
  // Tab B: The Workflow (Refactored)
  workflowPhases    Json?    // Array of { name, autonomy, guardrail }
  agentDirective    Json?    // DEPRECATED: Kept optional for legacy schema sync
  
  // Tab C: Business Case (VRCC + Financials)
  scoreValue        Int
  scoreCapability   Int
  scoreComplexity   Int
  scoreRiskFinal    Int      @default(0)
  scoreRiskAI       Int      @default(0)
  riskOverrideLog   String?
  tShirtSize        String   // "XS", "S", "M", "L", "XL"
  
  benefitRevenue    Float?
  benefitCostAvoidance Float? // Renamed from benefitCost
  benefitEstCost    Float?   // One-Time Implementation Cost
  benefitEfficiency Float?
  benefitTimeframe  String?   // "Monthly" or "Annually"
  
  // DFV Assessment - JSON structure: { desirability: {score: 1-5, justification: string}, feasibility: {...}, viability: {...} }
  dfvAssessment     Json?

  // Tab D: Execution
  definitionOfDone  String   
  keyDecisions      String   
  impactedSystems   String[]
  
  // New Execution Fields
  systemGuardrails     String?
  aiOpsRequirements    String?
  changeManagement     String?
  trainingRequirements String?

  // Capability Mapping (New Tagging Fields)
  capabilitiesExisting String[]
  capabilitiesMissing  String[]

  // Logic Engine
  capabilitiesConsumed CapabilityConsumed[]
  capabilitiesProduced CapabilityProduced[]
  
  // Outputs
  sequenceRank        Int?
  strategicRationale  String?   @db.Text
  matrixX             Float?
  matrixY             Float?
  // NEW: Rich Intelligence Fields (Promoted from Ideation)
  friction          String? @db.Text
  techAlignment     String? @db.Text
  strategyAlignment String? @db.Text

  // NEW: Capture Canvas Fields (Populated by Agents)
  businessCase      String? @db.Text // For ROI/Value tab
  workflowData      Json?            // For Workflow tab
  executionPlan     String? @db.Text // For Execution tab
  
  // NEW: Lineage
  originId          String? // The ID of the sticky note this came from
  promotionStatus   String? @default("PROMOTED") 

  @@index([originId])
}

// 3. Capabilities
model CapabilityConsumed {
  id            String      @id @default(uuid())
  opportunityId String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id])
  name          String
  status        String      // "EXISTING" or "MISSING"
}

model CapabilityProduced {
  id            String      @id @default(uuid())
  opportunityId String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id])
  name          String
}

// 4. Divergent Thinking Module (New)

model WorkshopContext {
  id              String   @id @default(uuid())
  workshopId      String   @unique
  workshop        Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  // Context Sources
  clientDossierUrl  String?
  clientBacklogUrl  String?
  marketResearchUrl String?
  
  // Data Blobs
  rawBacklog      Json?
  researchBrief   String?  @db.Text
  extractedConstraints Json?
  
  // Supreme Scout Pipeline Outputs
  researchBriefs     Json?    // Array of discrete research briefs
  reasoningSignature String?  @db.Text // Thought signature for Research Team handoff
  intelligenceAnalysis Json?  // Deep-Chain Analysis Results (Opportunity Cards)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model IdeaCard {
  id              String   @id @default(uuid())
  workshopId      String
  workshop        Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  title           String
  description     String   @db.Text
  tier            String   // Enum: STRATEGIC_BET, TABLE_STAKES, AGENTIC_AUTO
  source          String   // Enum: CLIENT_BACKLOG, MARKET_SIGNAL, WORKSHOP_GENERATED
  status          String   @default("ACTIVE") // ACTIVE, ARCHIVED, PROMOTED
  
  // Canvas Position (Whiteboard X/Y)
  xPosition       Float    @default(0)
  yPosition       Float    @default(0)
  
  // Metadata
  simulationResult  Json?
  genealogyMetadata Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  versions        IdeaVersion[]
}

model IdeaVersion {
  id              String   @id @default(uuid())
  ideaCardId      String
  ideaCard        IdeaCard @relation(fields: [ideaCardId], references: [id], onDelete: Cascade)
  
  timestamp       DateTime @default(now())
  descriptionSnapshot String @db.Text
  changeReason    String?
}

// 5. RAG Engine (New)

model Asset {
  id          String   @id @default(uuid())
  workshopId  String
  workshop    Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  name        String
  url         String   // Vercel Blob URL (renamed from blobUrl)
  type        String   // Enum: "DOSSIER" or "BACKLOG"
  status      String   @default("READY") // READY, INDEXING, ERROR
  
  createdAt   DateTime @default(now())
  
  chunks      DocumentChunk[]
}

model DocumentChunk {
  id          String   @id @default(uuid())
  assetId     String
  asset       Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  content     String   @db.Text
  chunkIndex  Int
  
  // Fallback: Float[] (Postgres Array) because pgvector extension is missing locally
  embedding   Float[]
}
